# å›¾ç‰‡ç”ŸæˆåŠŸèƒ½è¯¦ç»†æŠ€æœ¯åˆ†ææŠ¥å‘Š

> **ç”Ÿæˆæ—¶é—´**: 2025-09-11 16:29:41 +08:00
> **åˆ†æèŒƒå›´**: ä»å‰ç«¯äº¤äº’åˆ°åç«¯AIæ¥å£è°ƒç”¨çš„å®Œæ•´æŠ€æœ¯é“¾è·¯
> **å…³é”®å‘ç°**: å›¾ç‰‡ç”ŸæˆåŠŸèƒ½æ¶æ„å®Œæ•´ï¼Œä½†ç§¯åˆ†æ‰£å‡é€»è¾‘ç¼ºå¤±

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

æœ¬æŠ¥å‘Šæ·±å…¥åˆ†æäº†MkSaaSæ¨¡æ¿ä¸­å›¾ç‰‡ç”ŸæˆåŠŸèƒ½çš„å®Œæ•´æŠ€æœ¯å®ç°ï¼ŒåŒ…æ‹¬å‰ç«¯ç»„ä»¶æ¶æ„ã€APIè·¯ç”±è®¾è®¡ã€AIæ¨¡å‹é›†æˆå’Œç§¯åˆ†ç³»ç»Ÿã€‚é€šè¿‡ä»£ç å®¡æŸ¥å‘ç°ï¼Œç³»ç»Ÿå…·å¤‡å®Œæ•´çš„å›¾ç‰‡ç”Ÿæˆèƒ½åŠ›ï¼Œæ”¯æŒå¤šä¸ªAIæä¾›å•†ï¼Œä½†**å…³é”®å‘ç°æ˜¯ç§¯åˆ†æ‰£å‡é€»è¾‘å°šæœªé›†æˆåˆ°å›¾ç‰‡ç”Ÿæˆæµç¨‹ä¸­**ã€‚

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### æ ¸å¿ƒç»„ä»¶å…³ç³»å›¾

```
ç”¨æˆ·ç•Œé¢ (ImagePlayground)
    â†“
å‰ç«¯Hook (useImageGeneration)
    â†“
APIè·¯ç”± (/api/generate-images)
    â†“
AI SDKé›†æˆ (Vercel AI SDK)
    â†“
å¤šä¸ªAIæä¾›å•† (OpenAI, Replicate, Fireworks, Fal)
```

### æŠ€æœ¯æ ˆ

- **å‰ç«¯**: React 18 + TypeScript + Tailwind CSS
- **çŠ¶æ€ç®¡ç†**: React Hooks (useState)
- **AIé›†æˆ**: Vercel AI SDK
- **åç«¯**: Next.js 15 API Routes
- **æ•°æ®åº“**: Drizzle ORM + PostgreSQL
- **æ”¯ä»˜**: Stripe
- **AIæä¾›å•†**: OpenAI, Replicate, Fireworks AI, Fal AI

---

## ğŸ¨ å‰ç«¯å®ç°åˆ†æ

### 1. ä¸»è¦ç»„ä»¶ç»“æ„

#### ImagePlayground ç»„ä»¶ (`src/ai/image/components/ImagePlayground.tsx`)

**èŒè´£**: å›¾ç‰‡ç”Ÿæˆçš„ä¸»ç•Œé¢å®¹å™¨
**æ ¸å¿ƒåŠŸèƒ½**:
- ç®¡ç†æ¨¡å‹é€‰æ‹©çŠ¶æ€
- æ§åˆ¶æä¾›å•†å¯ç”¨/ç¦ç”¨
- åè°ƒå„å­ç»„ä»¶äº¤äº’

```typescript
// å…³é”®çŠ¶æ€ç®¡ç†
const [selectedModels, setSelectedModels] = useState<Record<ProviderKey, string>>(MODEL_CONFIGS.performance);
const [enabledProviders, setEnabledProviders] = useState(initializeProviderRecord(true));
const [mode, setMode] = useState<ModelMode>('performance');
```

#### PromptInput ç»„ä»¶ (`src/ai/image/components/PromptInput.tsx`)

**èŒè´£**: å¤„ç†ç”¨æˆ·è¾“å…¥å’Œæç¤ºè¯å»ºè®®
**æ ¸å¿ƒåŠŸèƒ½**:
- æç¤ºè¯è¾“å…¥å’ŒéªŒè¯
- éšæœºå»ºè®®ç”Ÿæˆ
- é”®ç›˜å¿«æ·é”®æ”¯æŒ (Enteræäº¤)

```typescript
// æäº¤å¤„ç†é€»è¾‘
const handleSubmit = () => {
  if (!isLoading && input.trim()) {
    onSubmit(input);
  }
};
```

### 2. æ ¸å¿ƒHook: useImageGeneration

**æ–‡ä»¶ä½ç½®**: `src/ai/image/hooks/use-image-generation.ts`

**æ ¸å¿ƒèŒè´£**:
- ç®¡ç†å›¾ç‰‡ç”ŸæˆçŠ¶æ€
- å¹¶å‘è°ƒç”¨å¤šä¸ªAIæä¾›å•†
- å¤„ç†é”™è¯¯å’Œè¶…æ—¶
- æ€§èƒ½è®¡æ—¶

**å…³é”®å®ç°ç»†èŠ‚**:

```typescript
// å¹¶å‘å›¾ç‰‡ç”Ÿæˆ
const fetchPromises = providers.map((provider) => {
  const modelId = providerToModel[provider];
  return generateImage(provider, modelId);
});

await Promise.all(fetchPromises);
```

**çŠ¶æ€ç®¡ç†**:
- `images`: ç”Ÿæˆçš„å›¾ç‰‡ç»“æœ
- `errors`: é”™è¯¯ä¿¡æ¯æ”¶é›†
- `timings`: æ€§èƒ½è®¡æ—¶æ•°æ®
- `failedProviders`: å¤±è´¥çš„æä¾›å•†åˆ—è¡¨
- `isLoading`: åŠ è½½çŠ¶æ€

---

## ğŸ”§ åç«¯APIå®ç°åˆ†æ

### APIè·¯ç”±: `/api/generate-images`

**æ–‡ä»¶ä½ç½®**: `src/app/api/generate-images/route.ts`

#### æ ¸å¿ƒé…ç½®

```typescript
// æä¾›å•†é…ç½®æ˜ å°„
const providerConfig: Record<ProviderKey, ProviderConfig> = {
  openai: {
    createImageModel: openai.image,
    dimensionFormat: 'size', // 1024x1024
  },
  fireworks: {
    createImageModel: fireworks.image,
    dimensionFormat: 'aspectRatio', // 1:1
  },
  replicate: {
    createImageModel: replicate.image,
    dimensionFormat: 'size',
  },
  fal: {
    createImageModel: fal.image,
    dimensionFormat: 'size',
  },
};
```

#### è¯·æ±‚å¤„ç†æµç¨‹

1. **è¯·æ±‚éªŒè¯**
   ```typescript
   if (!prompt || !provider || !modelId || !providerConfig[provider]) {
     return NextResponse.json({ error: 'Invalid request parameters' }, { status: 400 });
   }
   ```

2. **å›¾ç‰‡ç”Ÿæˆè°ƒç”¨**
   ```typescript
   const generatePromise = generateImage({
     model: config.createImageModel(modelId),
     prompt,
     ...(config.dimensionFormat === 'size'
       ? { size: DEFAULT_IMAGE_SIZE }
       : { aspectRatio: DEFAULT_ASPECT_RATIO }),
     seed: Math.floor(Math.random() * 1000000), // éšæœºç§å­
   });
   ```

3. **è¶…æ—¶æ§åˆ¶**
   ```typescript
   const TIMEOUT_MILLIS = 55 * 1000; // 55ç§’è¶…æ—¶
   const result = await withTimeout(generatePromise, TIMEOUT_MILLIS);
   ```

#### å…³é”®ç‰¹æ€§
- **è¶…æ—¶ä¿æŠ¤**: 55ç§’è¶…æ—¶æœºåˆ¶
- **é”™è¯¯å¤„ç†**: è¯¦ç»†çš„é”™è¯¯æ—¥å¿—å’Œç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
- **æ€§èƒ½ç›‘æ§**: è¯·æ±‚è€—æ—¶ç»Ÿè®¡
- **éšæœºç§å­**: ç¡®ä¿ç”Ÿæˆç»“æœçš„å¤šæ ·æ€§

---

## ğŸ¤– AIæä¾›å•†é›†æˆ

### æ”¯æŒçš„æä¾›å•†å’Œæ¨¡å‹

#### 1. Replicate
**ä¼˜åŠ¿**: å¼€æºæ¨¡å‹ä¸°å¯Œï¼Œæ€§ä»·æ¯”é«˜
**ä¸»è¦æ¨¡å‹**:
- `black-forest-labs/flux-1.1-pro`
- `black-forest-labs/flux-1.1-pro-ultra`
- `stability-ai/stable-diffusion-3.5-large`
- `ideogram-ai/ideogram-v2`

#### 2. OpenAI
**ä¼˜åŠ¿**: ç¨³å®šæ€§å¼ºï¼Œè´¨é‡ä¸€è‡´
**æ”¯æŒæ¨¡å‹**:
- `dall-e-2`
- `dall-e-3`

#### 3. Fireworks AI
**ä¼˜åŠ¿**: é€Ÿåº¦å¿«ï¼Œæˆæœ¬ä½
**ä¸»è¦æ¨¡å‹**:
- `accounts/fireworks/models/flux-1-dev-fp8`
- `accounts/fireworks/models/flux-1-schnell-fp8`

#### 4. Fal AI
**ä¼˜åŠ¿**: æ–°å…´å¹³å°ï¼Œæ¨¡å‹æ›´æ–°å¿«
**ä¸»è¦æ¨¡å‹**:
- `fal-ai/flux/dev`
- `fal-ai/flux-pro/v1.1-ultra`

### æ¨¡å¼é…ç½®

```typescript
export const MODEL_CONFIGS: Record<ModelMode, Record<ProviderKey, string>> = {
  performance: {
    replicate: 'black-forest-labs/flux-1.1-pro',
    openai: 'dall-e-3',
    fireworks: 'accounts/fireworks/models/flux-1-schnell-fp8',
    fal: 'fal-ai/flux/dev',
  },
  quality: {
    replicate: 'stability-ai/stable-diffusion-3.5-large',
    openai: 'dall-e-3',
    fireworks: 'accounts/fireworks/models/flux-1-dev-fp8',
    fal: 'fal-ai/flux-pro/v1.1-ultra',
  },
};
```

---

## ğŸ’³ ç§¯åˆ†ç³»ç»Ÿåˆ†æ

### ç§¯åˆ†ç³»ç»Ÿæ ¸å¿ƒç»„ä»¶

#### 1. ç§¯åˆ†ç®¡ç† (`src/credits/credits.ts`)

**æ ¸å¿ƒåŠŸèƒ½**:
- `getUserCredits()`: è·å–ç”¨æˆ·ç§¯åˆ†ä½™é¢
- `consumeCredits()`: æ‰£å‡ç§¯åˆ†ï¼ˆFIFOç­–ç•¥ï¼‰
- `hasEnoughCredits()`: æ£€æŸ¥ç§¯åˆ†æ˜¯å¦å……è¶³
- `addCredits()`: å¢åŠ ç§¯åˆ†

**FIFOæ¶ˆè´¹ç­–ç•¥**:
```typescript
// æŒ‰è¿‡æœŸæ—¶é—´ä¼˜å…ˆæ¶ˆè´¹ç§¯åˆ†
const transactions = await db
  .select()
  .from(creditTransaction)
  .where(/* æŸ¥è¯¢æ¡ä»¶ */)
  .orderBy(
    asc(creditTransaction.expirationDate),
    asc(creditTransaction.createdAt)
  );
```

#### 2. ç§¯åˆ†é…ç½® (`src/config/website.tsx`)

**ç§¯åˆ†åŒ…é…ç½®**:
- **åŸºç¡€åŒ…**: 100ç§¯åˆ† - $9.90
- **æ ‡å‡†åŒ…**: 200ç§¯åˆ† - $14.90 (æ¨è)
- **é«˜çº§åŒ…**: 500ç§¯åˆ† - $39.90
- **ä¼ä¸šåŒ…**: 1000ç§¯åˆ† - $69.90

**æ³¨å†Œèµ é€**: 50ç§¯åˆ†ï¼Œ30å¤©æœ‰æ•ˆæœŸ

#### 3. ç§¯åˆ†Hook (`src/hooks/use-credits.ts`)

```typescript
// ç§¯åˆ†æ¶ˆè´¹Hook
export function useConsumeCredits() {
  return useMutation({
    mutationFn: async ({ amount, description }) => {
      const result = await consumeCreditsAction({ amount, description });
      // é”™è¯¯å¤„ç†é€»è¾‘
    },
    onSuccess: () => {
      // åˆ·æ–°ç§¯åˆ†ä½™é¢
      queryClient.invalidateQueries({ queryKey: creditsKeys.balance() });
    },
  });
}
```

---

## ğŸš¨ å…³é”®å‘ç°ï¼šç§¯åˆ†æ‰£å‡é€»è¾‘ç¼ºå¤±

### é—®é¢˜åˆ†æ

é€šè¿‡æ·±å…¥ä»£ç å®¡æŸ¥ï¼Œå‘ç°äº†ä¸€ä¸ª**é‡è¦çš„æ¶æ„ç¼ºé™·**ï¼š

1. **APIè·¯ç”±æœªé›†æˆç§¯åˆ†æ£€æŸ¥**: `/api/generate-images` è·¯ç”±ä¸­æ²¡æœ‰ä»»ä½•ç§¯åˆ†ç›¸å…³çš„éªŒè¯æˆ–æ‰£å‡é€»è¾‘

2. **å‰ç«¯æœªè°ƒç”¨ç§¯åˆ†æ¶ˆè´¹**: `useImageGeneration` Hookä¸­æ²¡æœ‰è°ƒç”¨ `useConsumeCredits`

3. **ç¼ºå°‘èº«ä»½éªŒè¯**: APIè·¯ç”±æ²¡æœ‰ç”¨æˆ·èº«ä»½éªŒè¯ï¼Œæ— æ³•è·å–å½“å‰ç”¨æˆ·ID

### å½“å‰æµç¨‹ vs æœŸæœ›æµç¨‹

#### å½“å‰æµç¨‹ âŒ
```
ç”¨æˆ·è¾“å…¥æç¤ºè¯ â†’ ç›´æ¥è°ƒç”¨AIæ¥å£ â†’ è¿”å›å›¾ç‰‡
```

#### æœŸæœ›æµç¨‹ âœ…
```
ç”¨æˆ·è¾“å…¥æç¤ºè¯ â†’ èº«ä»½éªŒè¯ â†’ ç§¯åˆ†æ£€æŸ¥ â†’ ç§¯åˆ†é¢„æ‰£å‡ â†’ è°ƒç”¨AIæ¥å£ â†’ è¿”å›å›¾ç‰‡ â†’ ç§¯åˆ†ç¡®è®¤æ‰£å‡
```

---

## ğŸ”§ æŠ€æœ¯å®ç°å»ºè®®

### 1. APIè·¯ç”±æ”¹è¿›

åœ¨ `/api/generate-images/route.ts` ä¸­æ·»åŠ ï¼š

```typescript
import { auth } from '@/lib/auth';
import { consumeCredits, hasEnoughCredits } from '@/credits/credits';

export async function POST(req: NextRequest) {
  // 1. èº«ä»½éªŒè¯
  const session = await auth();
  if (!session?.user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  // 2. ç§¯åˆ†æ£€æŸ¥
  const CREDITS_PER_IMAGE = 5; // æ¯å¼ å›¾ç‰‡5ç§¯åˆ†
  const requiredCredits = CREDITS_PER_IMAGE;

  if (!(await hasEnoughCredits({ userId: session.user.id, requiredCredits }))) {
    return NextResponse.json({ error: 'Insufficient credits' }, { status: 402 });
  }

  try {
    // 3. é¢„æ‰£å‡ç§¯åˆ†
    await consumeCredits({
      userId: session.user.id,
      amount: requiredCredits,
      description: `Image generation: ${provider}/${modelId}`,
    });

    // 4. æ‰§è¡Œå›¾ç‰‡ç”Ÿæˆ
    const result = await withTimeout(generatePromise, TIMEOUT_MILLIS);

    return NextResponse.json(result);
  } catch (error) {
    // 5. å¤±è´¥æ—¶é€€è¿˜ç§¯åˆ†ï¼ˆå¯é€‰ï¼‰
    // await addCredits({ userId: session.user.id, amount: requiredCredits, ... });
    throw error;
  }
}
```

### 2. å‰ç«¯é›†æˆæ”¹è¿›

åœ¨ `useImageGeneration` Hookä¸­æ·»åŠ ç§¯åˆ†ç®¡ç†ï¼š

```typescript
import { useConsumeCredits } from '@/hooks/use-credits';

export function useImageGeneration() {
  const consumeCredits = useConsumeCredits();

  const startGeneration = async (prompt, providers, providerToModel) => {
    // å‰ç«¯ç§¯åˆ†æ£€æŸ¥ï¼ˆå¯é€‰ï¼Œåç«¯ä¹Ÿä¼šæ£€æŸ¥ï¼‰
    const totalCreditsNeeded = providers.length * CREDITS_PER_IMAGE;

    try {
      // æ‰§è¡Œå›¾ç‰‡ç”Ÿæˆ...
    } catch (error) {
      if (error.message.includes('Insufficient credits')) {
        // å¤„ç†ç§¯åˆ†ä¸è¶³é”™è¯¯
        setErrors([{ provider: 'system', message: 'ç§¯åˆ†ä¸è¶³ï¼Œè¯·è´­ä¹°ç§¯åˆ†åŒ…' }]);
      }
    }
  };
}
```

### 3. ç§¯åˆ†é…ç½®å»ºè®®

**æ¨èç§¯åˆ†æ¶ˆè´¹æ ‡å‡†**:
- **åŸºç¡€æ¨¡å‹** (Fireworkså¿«é€Ÿ): 3ç§¯åˆ†/å¼ 
- **æ ‡å‡†æ¨¡å‹** (OpenAI DALL-E): 5ç§¯åˆ†/å¼ 
- **é«˜çº§æ¨¡å‹** (Flux Pro): 8ç§¯åˆ†/å¼ 
- **Ultraæ¨¡å‹** (Flux Ultra): 12ç§¯åˆ†/å¼ 

---

## ğŸ“Š æ€§èƒ½åˆ†æ

### å½“å‰æ€§èƒ½æŒ‡æ ‡

1. **å¹¶å‘å¤„ç†**: æ”¯æŒåŒæ—¶è°ƒç”¨å¤šä¸ªAIæä¾›å•†
2. **è¶…æ—¶æ§åˆ¶**: 55ç§’è¶…æ—¶ä¿æŠ¤
3. **é”™è¯¯æ¢å¤**: å•ä¸ªæä¾›å•†å¤±è´¥ä¸å½±å“å…¶ä»–æä¾›å•†
4. **æ€§èƒ½ç›‘æ§**: è¯¦ç»†çš„è€—æ—¶ç»Ÿè®¡

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç¼“å­˜æœºåˆ¶**: å¯¹ç›¸åŒæç¤ºè¯çš„ç»“æœè¿›è¡Œç¼“å­˜
2. **é˜Ÿåˆ—ç³»ç»Ÿ**: é«˜å¹¶å‘æ—¶ä½¿ç”¨é˜Ÿåˆ—ç®¡ç†è¯·æ±‚
3. **CDNé›†æˆ**: ç”Ÿæˆçš„å›¾ç‰‡å­˜å‚¨åˆ°CDN
4. **é¢„ä»˜è´¹æ¨¡å¼**: æ‰¹é‡é¢„è´­AIæœåŠ¡é™ä½å•æ¬¡æˆæœ¬

---

## ğŸ”’ å®‰å…¨è€ƒè™‘

### å½“å‰å®‰å…¨æªæ–½
- ç¯å¢ƒå˜é‡ä¿æŠ¤APIå¯†é’¥
- è¾“å…¥éªŒè¯å’Œé”™è¯¯å¤„ç†
- è¶…æ—¶ä¿æŠ¤é˜²æ­¢èµ„æºå ç”¨

### å®‰å…¨æ”¹è¿›å»ºè®®
1. **é€Ÿç‡é™åˆ¶**: é˜²æ­¢APIæ»¥ç”¨
2. **å†…å®¹è¿‡æ»¤**: æ£€æµ‹ä¸å½“å†…å®¹è¯·æ±‚
3. **ç”¨æˆ·é…é¢**: æ¯æ—¥/æ¯æœˆç”Ÿæˆé™åˆ¶
4. **å®¡è®¡æ—¥å¿—**: è®°å½•æ‰€æœ‰ç”Ÿæˆè¯·æ±‚

---

## ğŸ“ˆ æ‰©å±•å»ºè®®

### çŸ­æœŸä¼˜åŒ– (1-2å‘¨)
1. âœ… é›†æˆç§¯åˆ†æ‰£å‡é€»è¾‘
2. âœ… æ·»åŠ ç”¨æˆ·èº«ä»½éªŒè¯
3. âœ… å®ç°é”™è¯¯å¤„ç†ä¼˜åŒ–
4. âœ… æ·»åŠ ç§¯åˆ†ä¸è¶³æç¤º

### ä¸­æœŸæ”¹è¿› (1-2æœˆ)
1. ğŸ”„ å®ç°å›¾ç‰‡ç¼“å­˜æœºåˆ¶
2. ğŸ”„ æ·»åŠ ç”Ÿæˆå†å²è®°å½•
3. ğŸ”„ æ”¯æŒæ‰¹é‡ç”Ÿæˆ
4. ğŸ”„ å›¾ç‰‡è´¨é‡é€‰æ‹©

### é•¿æœŸè§„åˆ’ (3-6æœˆ)
1. ğŸš€ è‡ªå®šä¹‰æ¨¡å‹è®­ç»ƒ
2. ğŸš€ å›¾ç‰‡ç¼–è¾‘åŠŸèƒ½
3. ğŸš€ APIå¼€æ”¾å¹³å°
4. ğŸš€ ç§»åŠ¨ç«¯é€‚é…

---

## ğŸ¯ æ€»ç»“

MkSaaSçš„å›¾ç‰‡ç”ŸæˆåŠŸèƒ½åœ¨æŠ€æœ¯æ¶æ„ä¸Šè®¾è®¡è‰¯å¥½ï¼Œå…·å¤‡ï¼š
- âœ… **å®Œæ•´çš„å‰ç«¯äº¤äº’ä½“éªŒ**
- âœ… **å¤šæä¾›å•†å¹¶å‘æ”¯æŒ**
- âœ… **robustçš„é”™è¯¯å¤„ç†æœºåˆ¶**
- âœ… **æ€§èƒ½ç›‘æ§å’Œè¶…æ—¶ä¿æŠ¤**

ä½†å­˜åœ¨**å…³é”®ç¼ºé™·**ï¼š
- âŒ **ç§¯åˆ†æ‰£å‡é€»è¾‘å®Œå…¨ç¼ºå¤±**
- âŒ **ç¼ºå°‘ç”¨æˆ·èº«ä»½éªŒè¯**
- âŒ **æ— ä½¿ç”¨æˆæœ¬æ§åˆ¶**

**ä¼˜å…ˆå»ºè®®**: ç«‹å³å®ç°ç§¯åˆ†é›†æˆï¼Œè¿™æ˜¯å•†ä¸šåŒ–è¿è¥çš„å¿…è¦æ¡ä»¶ã€‚

---

**æŠ¥å‘Šç”Ÿæˆ**: AIåŠ©æ‰‹ Claude Sonnet 4
**æœ€åæ›´æ–°**: 2025-09-11 16:29:41 +08:00
