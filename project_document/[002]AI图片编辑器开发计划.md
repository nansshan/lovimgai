# [002] AI图片编辑器开发计划

**生成时间:** 2025-09-14T09:56:00+08:00
**项目目标:** 基于现有MkSaaS项目改造，开发AI图片生成对话系统
**实施方案:** 最小化改造方案，最大化复用现有系统
**预计工期:** 7-9天

## 📋 任务总览

| 阶段 | 任务数 | 预计时间 | 关键内容 |
|------|--------|----------|----------|
| 基础架构 | 5个 | 2天 | 数据库、API、AI配置 |
| 界面组件 | 4个 | 2天 | 布局、侧边栏、对话、预览 |
| 功能集成 | 3个 | 2天 | 状态管理、页面集成、上传 |
| 优化完善 | 4个 | 1-2天 | 响应式、国际化、性能 |

## 🎯 核心需求

1. **界面布局**: 三栏式（侧边栏256px + 对话区50% + 预览区50%）
2. **会话管理**: 显示前10字符+时间，支持切换
3. **AI模型**: google/nano-banana（8积分）
4. **异步处理**: 轮询（3秒/40秒超时）+ Webhook
5. **积分策略**: 先扣费后服务，失败不回滚
6. **Canvas模式**: 暂时禁用，显示"Coming Soon"

## 📝 详细任务清单

### Phase 1: 基础架构层（Day 1-2）

#### Task 1: 数据库Schema设计和迁移 ✅ **已完成**
**ID:** 260c57b4-787b-4bac-b32b-3144ecdab458
**依赖:** 无
**完成时间:** 2025-09-14T10:20:31+08:00
**实施要点:**
- ✅ 创建aiPhotoSession表（会话管理）
- ✅ 创建aiPhotoTask表（任务记录）
- ✅ 设置外键关系和索引
- ✅ 执行数据库迁移（0004_colossal_luckman.sql）
**验证结果:**
- ✅ Schema定义语法正确
- ✅ 迁移文件成功生成
- ✅ 数据库迁移成功执行
- ✅ 表结构包含所有必要字段和索引

#### Task 2: AI模型配置和接口抽象层 ✅ **已完成**
**ID:** 3c414654-cc84-4653-b9af-a5930a6189a3
**依赖:** 无
**完成时间:** 2025-09-14T10:20:31+08:00
**实施要点:**
- ✅ 添加google/nano-banana到provider-config.ts
- ✅ 创建AI服务工厂模式
- ✅ 实现Replicate服务类
- ✅ 配置环境变量（WEBHOOK_URL, AI_PHOTO_MODEL_ENDPOINT）
**验证结果:**
- ✅ 模型配置文件创建完成
- ✅ AI服务抽象层接口定义清晰
- ✅ Replicate服务实现完整
- ✅ 环境变量正确配置

#### Task 3: 会话管理API接口开发 ✅ **已完成**
**ID:** 2c7a9147-e83d-4372-94a9-b87c0133aa56
**依赖:** Task 1
**完成时间:** 2025-09-14T10:20:31+08:00
**实施要点:**
- ✅ POST /api/ai-photo-editor/sessions（创建会话）
- ✅ GET /api/ai-photo-editor/sessions（获取列表）
- ✅ PUT /api/ai-photo-editor/sessions/[id]（更新会话）
- ✅ GET /api/ai-photo-editor/sessions/[id]（获取详情）
- ✅ 集成Better Auth认证
**验证结果:**
- ✅ API能正确创建新会话
- ✅ 能获取用户的会话列表
- ✅ 能更新会话信息
- ✅ 未认证用户返回401错误
- ✅ 完整的类型定义支持

#### Task 4: AI处理和任务状态API ✅ **已完成**
**ID:** e850b09e-4f4f-4570-a36d-09fc61877928
**依赖:** Task 1, Task 2
**完成时间:** 2025-09-14T10:20:31+08:00
**实施要点:**
- ✅ POST /api/ai-photo-editor/process（处理请求）
- ✅ GET /api/ai-photo-editor/tasks/[taskId]（查询状态）
- ✅ PUT /api/ai-photo-editor/tasks/[taskId]（更新状态）
- ✅ 集成积分扣减逻辑（失败不回滚）
- ✅ 调用Replicate API
**验证结果:**
- ✅ 积分检查和扣减正确
- ✅ 任务记录成功创建
- ✅ AI服务调用成功
- ✅ 任务状态查询正常
- ✅ 完整的错误处理和日志记录

#### Task 5: Webhook回调处理API ✅ **已完成**
**ID:** 9f3b9970-efcd-4c52-975c-9799896e663e
**依赖:** Task 1
**完成时间:** 2025-09-14T10:20:31+08:00
**实施要点:**
- ✅ POST /api/webhooks/ai-photo-completion
- ✅ 验证Replicate签名（预留实现）
- ✅ 下载并上传图片到存储
- ✅ 更新任务状态
- ✅ 完整的错误处理和日志记录
**验证结果:**
- ✅ Webhook能正确接收数据
- ✅ 图片成功下载和上传
- ✅ 任务状态正确更新
- ✅ 错误处理完善
- ✅ 支持健康检查（GET方法）

### Phase 2: 界面组件开发（Day 3-4）

#### Task 6: 核心布局组件开发 ✅ **已完成**
**ID:** bdd3251c-1890-4479-baa0-2be68ea8bfd8
**依赖:** 无
**完成时间:** 2025-09-14T11:00:59+08:00
**实施要点:**
- ✅ PhotoEditorLayout组件 - 三栏响应式布局（256px侧边栏 + 50%对话区 + 50%预览区）
- ✅ 响应式设计 - 桌面/平板/移动端适配
- ✅ 抽屉模式支持预留
- ✅ Tailwind CSS样式完整
**验证结果:**
- ✅ 布局组件正确渲染三栏结构
- ✅ 响应式断点工作正常
- ✅ 组件接口设计合理，支持插槽模式

#### Task 7: 侧边栏和会话管理组件 ✅ **已完成**
**ID:** 93cc83b2-c9e8-4335-9260-023752567a89
**依赖:** Task 6
**完成时间:** 2025-09-14T11:00:59+08:00
**实施要点:**
- ✅ PhotoEditorSidebar主组件 - 完整侧边栏功能
- ✅ ModeToggle（Canvas禁用+Coming Soon标识）
- ✅ RecentEditList（会话列表，支持加载状态和空状态）
- ✅ RippleButton效果（集成magicui组件）
**验证结果:**
- ✅ 新建对话按钮动画效果正常
- ✅ Chat/Canvas模式切换UI完整，Canvas正确禁用
- ✅ 会话列表支持时间格式化和国际化
- ✅ 紧凑版侧边栏适配移动端

#### Task 8: 对话界面和输入组件 ✅ **已完成**
**ID:** 1400c13e-a0d4-4227-93b5-6abe3b43dc0d
**依赖:** Task 6
**完成时间:** 2025-09-14T11:00:59+08:00
**实施要点:**
- ✅ ChatInterface组件 - 完整对话界面
- ✅ 图片上传支持（多文件，20MB限制预留）
- ✅ 消息气泡设计（用户/AI区分）
- ✅ 发送/停止按钮状态管理
- ✅ 空状态和加载状态处理
**验证结果:**
- ✅ 消息展示区域滚动正常
- ✅ 图片预览和删除功能完整
- ✅ 键盘快捷键（Enter发送）支持
- ✅ 状态指示器和错误处理完善

#### Task 9: 图片预览面板组件 ✅ **已完成**
**ID:** 76ac7e76-2611-475a-b45b-2bd34a21e194
**依赖:** Task 6
**完成时间:** 2025-09-14T11:00:59+08:00
**实施要点:**
- ✅ ImagePreviewPanel组件 - 主图85% + 缩略图15%布局
- ✅ 点击切换功能和选中状态
- ✅ 图片下载和缩放功能预留
- ✅ 生成状态显示和空状态处理
**验证结果:**
- ✅ 主图预览区域比例正确，图片居中显示
- ✅ 缩略图列表横向滚动正常
- ✅ 图片信息覆盖层设计美观
- ✅ 生成中状态动画效果良好

### Phase 3: 功能集成（Day 5-6）

#### Task 10: 状态管理和Hooks开发
**ID:** 4a0fb4a4-b79a-4ed2-b70e-d4fdd9b292d0
**依赖:** 无
**实施要点:**
- Zustand store配置
- use-edit-sessions Hook
- use-image-generation-v2 Hook
- 轮询机制实现

#### Task 11: 主页面集成和路由配置
**ID:** 5320d2df-2ad9-4359-a190-206073a3b209
**依赖:** Task 6, 7, 8, 9, 10
**实施要点:**
- /ai-photo-editor页面
- 组件集成和布局
- 认证保护
- 错误边界

#### Task 12: 轮询和错误处理优化
**ID:** 2bed7f2a-1aa0-4b43-a7e3-ae25f9df7cff
**依赖:** Task 10
**实施要点:**
- 3秒轮询间隔
- 40秒超时处理
- 错误提示UI
- 页面隐藏暂停

#### Task 13: 文件上传集成和优化
**ID:** eecfc0eb-258b-491c-b765-22644a522e1f
**依赖:** Task 8
**实施要点:**
- 集成uploadFileFromBrowser
- 20MB大小限制
- 多文件上传
- 上传进度显示

### Phase 4: 优化完善（Day 7-8）

#### Task 14: 响应式布局和移动端适配
**ID:** e0f8d4ca-8716-4d41-a365-aa6cec82720c
**依赖:** Task 6, 11
**实施要点:**
- 响应式断点调整
- 抽屉模式实现
- 移动端优化
- 触摸交互

#### Task 15: 国际化和文案配置
**ID:** 035bcaa2-9f1d-4d5f-89b7-606200afb541
**依赖:** Task 11
**实施要点:**
- 中英文文案配置
- useTranslations集成
- 日期格式化
- 文案测试

#### Task 16: 性能优化和测试完善
**ID:** ecb5ae7d-7876-41fa-b94d-2e3892b6cc14
**依赖:** Task 11, 12, 14
**实施要点:**
- React.memo优化
- 图片懒加载
- 虚拟滚动
- 端到端测试

## 🔧 问题修复记录

### Next.js服务端/客户端组件错误修复 ✅ **已解决**
**时间:** 2025-09-14T11:04:59+08:00
**问题描述:**
- 错误：Event handlers cannot be passed to Client Component props
- 原因：服务端组件AIPhotoEditorPage直接向客户端组件传递事件处理函数

**解决方案:**
- ✅ 创建PhotoEditorClient客户端组件包装器
- ✅ 将所有交互逻辑移至客户端组件
- ✅ 服务端组件只负责国际化和路由
- ✅ 添加模拟数据增强演示效果

**技术细节:**
- PhotoEditorClient: 统一管理状态和事件处理
- 服务端组件: AIPhotoEditorPage保持简洁
- 数据流: 完全在客户端组件内部处理
- 演示数据: 2个模拟会话 + 对话历史

## 🔄 开发流程

### 并行开发机会
- Task 1, 2 可并行（基础配置）
- Task 6, 10 可并行（组件和状态）
- Task 7, 8, 9 可在Task 6完成后并行

### 关键路径
```
Task 1 → Task 3, 4, 5 → Task 11 → Task 14, 15, 16
Task 2 → Task 4
Task 6 → Task 7, 8, 9 → Task 11
Task 10 → Task 11, 12
```

### 测试节点
1. **基础架构完成**: 测试API接口和数据库
2. **组件开发完成**: 测试组件交互
3. **集成完成**: 端到端测试
4. **优化完成**: 性能和兼容性测试

## ⚠️ 风险点和注意事项

1. **Replicate签名验证**: 需要用户提供文档
2. **积分扣减策略**: 失败不回滚需明确告知用户
3. **轮询性能**: 移动端需特别注意电量消耗
4. **图片存储成本**: 需要制定清理策略
5. **并发控制**: 单用户不能同时多个任务

## 📊 进度跟踪

使用任务管理系统跟踪进度：
```bash
# 查看所有任务
任务ID和状态会实时更新

# 标记完成
每完成一个任务立即更新状态

# 查看依赖
系统会显示可执行的下一批任务
```

## ✅ 验收标准

1. **功能完整性**: 所有核心功能正常工作
2. **性能指标**: 页面加载<3秒，轮询稳定
3. **用户体验**: 界面流畅，错误提示清晰
4. **代码质量**: 符合项目规范，有适当注释
5. **测试覆盖**: 关键路径有测试保护

---

**计划制定完成时间:** 2025-09-14T09:56:00+08:00
**下一步:** 开始执行Task 1和Task 2（可并行）
