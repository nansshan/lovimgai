# [001] 侧边栏改造开发文档 - AI图片编辑界面

**生成时间:** 2025-09-13T23:22:08+08:00
**开发目标:** 改造现有侧边栏，实现AI图片生成对话系统
**参考界面:** 类似ChatGPT + DALL-E的图片编辑界面
**项目基础:** 基于MkSaaS项目架构，复用现有认证、积分、存储系统

## 🎯 需求分析

### 核心功能需求
1. **新建会话按钮** - 位于侧边栏顶部，使用RippleButton动画效果
2. **模式切换按钮** - Chat/Canvas两个切换按钮，Canvas完全禁用显示"Coming Soon"
3. **Recent Edit列表** - 显示前5字符+创建时间，点击切换会话
4. **对话输入界面** - 支持文字描述和多图片上传（最大20MB/张）
5. **AI模型选择器** - 位于输入框下方，Cursor样式，仅显示模型名称+积分消耗
6. **图片预览区域** - 主图85% + 缩略图15%，仅显示当前会话图片
7. **异步任务处理** - 轮询+Webhook机制，40秒超时

### 界面布局需求

#### Chat模式 (默认)
- **侧边栏:** 固定256px宽度
- **对话区域:** 50%剩余空间，支持文字+图片输入
- **图片预览区域:** 50%剩余空间，主图预览+缩略图列表
- **模型选择器:** 位于输入框下方，类似Cursor样式

#### Canvas模式 (预留架构)
- **按钮状态:** 完全禁用（灰色），显示"Coming Soon"提示
- **功能状态:** 暂不开发，待设计完整后实现

## 📐 界面布局设计 (ASCII)

### Chat模式布局
```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                           主界面                                                      │
├─────────────────┬─────────────────────────────────────────┬─────────────────────────────────────────┤
│   侧边栏        │            Chat模式 - 对话界面区域 (50%) │         图片预览区域 (50%)               │
│   (固定256px)   │                                         │                                         │
│ ┌─────────────┐ │ ┌─────────────────────────────────────┐ │ ┌─────────────────────────────────────┐ │
│ │ New Edit    │ │ │           对话记录展示区             │ │ │           主图片预览                 │ │
│ │ (RippleBtn) │ │ │                                     │ │ │         (占预览区85%)               │ │
│ └─────────────┘ │ │  ┌─────────────────┐  ┌─────────┐  │ │ │                                     │ │
│ ┌──────┬──────┐ │ │  │   用户消息      │  │   AI    │  │ │ │                                     │ │
│ │[Chat]│Canvas│ │ │  │    (右侧)      │  │  消息   │  │ │ │                                     │ │
│ │ 🔥   │Coming│ │ │  │               │  │ (左侧)  │  │ │ │                                     │ │
│ │      │ Soon │ │ │  └─────────────────┘  └─────────┘  │ │ └─────────────────────────────────────┘ │
│ └──────┴──────┘ │ │                                     │ │ ┌─────────────────────────────────────┐ │
│ Recent Edit     │ │ ┌─────────────────────────────────────┐ │ │         缩略图列表区                 │ │
│ ┌─────────────┐ │ │ │            输入框区域                │ │ │       (占预览区15%)                 │ │
│ │前5字符+时间 │ │ │ │  [📎] [输入框..............] [发送] │ │ │ [img1] [img2] [img3] [img4] [img5] │ │
│ └─────────────┘ │ │ │                                     │ │ └─────────────────────────────────────┘ │
│ ┌─────────────┐ │ │   [🤖 Nano Banana - 8积分] ▼      │ │                                         │
│ │会话2        │ │ │ └─────────────────────────────────────┘ │                                         │
│ └─────────────┘ │ └─────────────────────────────────────┘ │                                         │
└─────────────────┴─────────────────────────────────────────┴─────────────────────────────────────────┘
```

## 🔍 组件设计详情

### 1. PhotoEditorLayout (主布局组件)
```typescript
interface PhotoEditorLayoutProps {
  children: React.ReactNode;
}
// 负责整体三栏布局：侧边栏(256px) + 对话区(50%) + 预览区(50%)
```

### 2. ModeToggle (模式切换组件)
```typescript
interface ModeToggleProps {
  currentMode: 'chat' | 'canvas';
  onModeChange: (mode: 'chat' | 'canvas') => void;
}
// Chat按钮: 默认高亮，显示对话界面
// Canvas按钮: 完全禁用（灰色不可点击），显示"Coming Soon"提示标识
```

### 3. PhotoEditorSidebar (图片编辑侧边栏)
```typescript
interface PhotoEditorSidebarProps {
  currentSessionId?: string;
  currentMode: 'chat' | 'canvas';
  onSessionChange: (sessionId: string) => void;
  onNewSession: () => void;
  onModeChange: (mode: 'chat' | 'canvas') => void;
}
// 包含：RippleButton(新建会话) + ModeToggle(模式切换) + RecentEditList(历史会话)
```

### 4. RecentEditList (历史会话列表)
```typescript
interface EditSession {
  id: string;
  title: string; // 第一条prompt的前5字符
  createdAt: Date;
  firstPrompt: string; // 完整的第一条prompt，用于生成title
}

interface RecentEditListProps {
  sessions: EditSession[];
  currentSessionId?: string;
  onSessionSelect: (sessionId: string) => void;
}
// 展示内容：第一条prompt的前5字符 + 创建时间
// 点击行为：切换到该会话
// 不显示：任务数量、图片缩略图
```

### 5. ModelSelector (AI模型选择器)
```typescript
interface ModelSelectorProps {
  selectedModel: string;
  onModelChange: (modelId: string) => void;
  userCredits: number;
}
// 位置：输入框下方，类似Cursor的模型选择器样式
// 显示内容：仅显示模型名称和积分消耗值，不显示能力标签
// 积分处理：积分不足的模型不显示在选择列表中
// 配置管理：使用独立配置文件 src/config/ai-models-config.ts
```

### 6. ImagePreviewPanel (图片预览面板)
```typescript
interface ImagePreviewPanelProps {
  mainImage?: string;
  thumbnails: string[]; // 当前会话的历史图片，不是用户所有图片
  onThumbnailClick: (imageUrl: string) => void;
  className?: string;
}
// 布局结构：主图预览区域85% + 缩略图列表区域15%
// 缩略图交互：点击后替换主图显示
// 功能限制：不需要图片下载/保存功能，不支持全屏查看
// 数据范围：仅显示当前会话的图片
```

### 7. ImageUploadInput (图片上传输入)
```typescript
interface ImageUploadInputProps {
  onTextSubmit: (text: string) => void;
  onImageUpload: (files: File[]) => void;
  onImageWithTextSubmit: (text: string, files: File[]) => void;
  isLoading?: boolean;
  maxImages?: number; // 最大图片数量限制
  maxSize?: number;   // 单张图片最大大小 (默认20MB)
}
// 支持：文本输入 + 多图片上传 + 组合提交
// 限制：单张图片最大20MB，支持多张上传
```

## 🔧 技术实现要点

### 1. AI模型配置管理
```typescript
// src/config/ai-models-config.ts
interface AIModel {
  id: string;
  name: string;
  provider: string;
  creditsPerUse: number;
  maxImages: number;
}

const AVAILABLE_MODELS: AIModel[] = [
  {
    id: 'google/nano-banana',
    name: 'Nano Banana',
    provider: 'Google',
    creditsPerUse: 8,
    maxImages: 1
  }
  // 其他模型暂不配置，待后续需要时添加
];
```

### 2. 状态管理 (Zustand)
```typescript
interface PhotoEditorStore {
  // 会话管理
  currentSessionId: string | null;
  sessions: EditSession[];

  // 图片管理
  currentImages: string[];
  selectedImageIndex: number;

  // UI状态
  sidebarOpen: boolean;
  previewPanelOpen: boolean;

  // 模式管理
  currentMode: 'chat' | 'canvas';
}
```

### 3. 数据库表结构扩展
```sql
-- 基于现有MkSaaS项目schema扩展

-- AI会话表 (ai_photo_sessions) - 新增表
CREATE TABLE ai_photo_sessions (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL,
  title TEXT NOT NULL, -- 会话标题 (第一条prompt的前5字符)
  first_prompt TEXT, -- 完整的第一条prompt
  task_count INTEGER DEFAULT 0,
  last_activity TIMESTAMP NOT NULL,
  created_at TIMESTAMP DEFAULT now() NOT NULL,
  updated_at TIMESTAMP DEFAULT now() NOT NULL,

  CONSTRAINT ai_photo_sessions_user_id_fk FOREIGN KEY (user_id)
    REFERENCES public.user(id) ON DELETE cascade ON UPDATE no action
);

-- AI任务表 (ai_photo_tasks) - 新增表
CREATE TABLE ai_photo_tasks (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL,
  session_id TEXT NOT NULL,
  prompt TEXT NOT NULL,
  input_images JSON, -- 用户上传的参考图片链接数组
  output_image_url TEXT, -- AI生成的结果图片链接
  status TEXT NOT NULL CHECK (status IN ('pending', 'processing', 'completed', 'failed')),
  task_id TEXT, -- 第三方AI接口返回的任务ID
  provider_model TEXT, -- 使用的AI模型名称
  credits_cost INTEGER NOT NULL,
  error_message TEXT,
  sequence_order INTEGER NOT NULL,
  created_at TIMESTAMP DEFAULT now() NOT NULL,
  updated_at TIMESTAMP DEFAULT now() NOT NULL,
  completed_at TIMESTAMP,

  CONSTRAINT ai_photo_tasks_user_id_fk FOREIGN KEY (user_id)
    REFERENCES public.user(id) ON DELETE cascade ON UPDATE no action,
  CONSTRAINT ai_photo_tasks_session_id_fk FOREIGN KEY (session_id)
    REFERENCES public.ai_photo_sessions(id) ON DELETE cascade ON UPDATE no action
);

-- 索引设计
CREATE INDEX idx_ai_photo_sessions_user_activity ON ai_photo_sessions(user_id, last_activity DESC);
CREATE INDEX idx_ai_photo_tasks_session_order ON ai_photo_tasks(session_id, sequence_order ASC);
CREATE INDEX idx_ai_photo_tasks_task_id ON ai_photo_tasks(task_id); -- 用于webhook查询
CREATE INDEX idx_ai_photo_tasks_user_created ON ai_photo_tasks(user_id, created_at DESC);
CREATE INDEX idx_ai_photo_tasks_status ON ai_photo_tasks(status);

-- 复用现有表：
-- - user: 用户认证和基本信息
-- - user_credit: 积分余额
-- - credit_transaction: 积分交易记录 (用于AI图片生成扣减积分)
```

### 4. 核心业务流程
```typescript
// 1. 前端轮询实现
const pollTaskStatus = async (taskId: string) => {
  let pollCount = 0;
  const maxPollCount = 13; // 40秒 ÷ 3秒

  const interval = setInterval(async () => {
    if (document.hidden) return; // 移动端优化

    pollCount++;

    try {
      const response = await fetch(`/api/tasks/${taskId}`);
      const task = await response.json();

      if (task.status === 'completed') {
        displayResult(task.output_image_url);
        clearInterval(interval);
      } else if (task.status === 'failed') {
        displayError(task.error_message);
        clearInterval(interval);
      } else if (pollCount >= maxPollCount) {
        displayTimeout("对话失败"); // 40秒超时提示
        clearInterval(interval);
      }
    } catch (error) {
      displayNetworkError("网络异常"); // 网络异常提示
      clearInterval(interval);
    }
  }, 3000);
};

// 2. Webhook处理实现
export async function POST(request: Request) {
  const webhookData = await request.json();

  try {
    // 下载AI生成的图片
    const imageResponse = await fetch(webhookData.output_url);
    const imageBuffer = await imageResponse.arrayBuffer();

    // 上传到文件存储服务器
    const uploadResult = await uploadToStorage(imageBuffer);

    // 更新数据库任务状态
    await updateTask(webhookData.task_id, {
      status: 'completed',
      output_image_url: uploadResult.url,
      completed_at: new Date()
    });
  } catch (error) {
    await updateTask(webhookData.task_id, {
      status: 'failed',
      error_message: error.message
    });
  }
}

// 3. 积分检查与扣减 - 集成MkSaaS积分系统
const processAIRequest = async (userId: string, prompt: string, selectedModel: string) => {
  const { getUserCredits, consumeCredits } = await import('@/credits/credits');
  const { CREDIT_TRANSACTION_TYPE } = await import('@/credits/types');

  // 检查积分 - 使用现有积分系统
  const userCredits = await getUserCredits(userId);
  const model = ModelConfigManager.getModelConfig(selectedModel);

  if (userCredits < model.creditsPerUse) {
    throw new Error('积分不足，请先充值');
  }

  // 扣减积分 (使用现有FIFO消费机制，失败不回滚)
  await consumeCredits({
    userId,
    amount: model.creditsPerUse,
    description: `AI图片生成 - ${model.name}`
  });

  // 调用AI接口
  const aiResponse = await callAIService(prompt, selectedModel);
  return aiResponse.task_id;
};
```

### 5. AI接口抽象层
```typescript
// AI服务接口抽象，支持平台切换
interface AIService {
  createPrediction(params: CreatePredictionParams): Promise<PredictionResponse>;
  getPrediction(taskId: string): Promise<PredictionStatus>;
}

// AI服务工厂
class AIServiceFactory {
  static createService(provider: string = 'replicate'): AIService {
    switch (provider) {
      case 'replicate':
        return new ReplicateService(process.env.REPLICATE_API_KEY!, process.env.WEBHOOK_URL!);
      // 未来可以轻松添加其他平台
      default:
        throw new Error(`Unsupported AI provider: ${provider}`);
    }
  }
}
```

## 📱 响应式设计

### 桌面端 (≥1024px)
- 三栏布局：侧边栏(256px) + 对话区(50%) + 预览区(50%)
- 主图预览占85%高度，缩略图占15%高度

### 平板端 (768px - 1023px)
- 两栏布局：对话区 + 预览区 (各占50%)
- 侧边栏折叠为抽屉模式（点击按钮触发）

### 移动端 (<768px)
- 单栏布局：对话区全屏显示
- 侧边栏和预览区均为抽屉模式（点击按钮触发，不支持手势滑动）
- 暂不支持全屏查看功能

## 📁 文件结构规划

```
src/
├── config/
│   └── ai-models-config.ts              # ✨ 新建 - AI模型配置文件
├── components/
│   ├── ai-elements/
│   │   ├── mode-toggle.tsx               # ✨ 新建 - Chat/Canvas模式切换
│   │   ├── recent-edit-list.tsx          # ✨ 新建 - 历史会话列表
│   │   ├── image-preview-panel.tsx       # ✨ 新建 - 图片预览面板
│   │   ├── image-upload-input.tsx        # ✨ 新建 - 图片上传输入
│   │   ├── model-selector.tsx            # ✨ 新建 - 模型选择器
│   │   ├── photo-editor-sidebar.tsx      # ✨ 新建 - 图片编辑侧边栏
│   │   └── photo-editor-layout.tsx       # ✨ 新建 - 整体布局组件
│   └── animate-ui/buttons/               # ✅ 复用现有 - 动画按钮组件
├── ai/
│   └── image/
│       ├── hooks/
│       │   ├── use-edit-sessions.ts      # ✨ 新建 - 会话管理Hook
│       │   └── use-image-upload.ts       # ✨ 新建 - 图片上传Hook
│       └── lib/
│           ├── edit-session-types.ts     # ✨ 新建 - 会话类型定义
│           └── image-upload-utils.ts     # ✨ 新建 - 上传工具函数
└── app/
    └── [locale]/
        └── (protected)/
            └── ai-photo-editor/
                └── page.tsx              # ✨ 新建 - 图片编辑页面
        └── api/
            └── ai-photo-editor/
                ├── sessions/
                │   ├── route.ts          # ✨ 新建 - 会话管理API
                │   └── [id]/
                │       └── route.ts      # ✨ 新建 - 单个会话操作API
                ├── process/
                │   └── route.ts          # ✨ 新建 - AI处理API
                └── tasks/
                    └── [taskId]/
                        └── route.ts      # ✨ 新建 - 任务状态查询API
            └── webhooks/
                └── ai-photo-completion/
                    └── route.ts          # ✨ 新建 - AI完成回调API
```

## 📋 开发任务规划

### Phase 1: 基础架构和数据层 (2天)
- [ ] `src/db/schema.ts` - 新增AI相关表定义 (aiPhotoSession, aiPhotoTask)
- [ ] 数据库迁移文件生成和执行
- [ ] `src/config/ai-models-config.ts` - AI模型配置文件 (仅google/nano-banana)
- [ ] `src/ai/image/lib/types.ts` - AI相关类型定义
- [ ] 基础API路由结构创建

### Phase 2: 核心组件开发 (2天)
- [ ] `PhotoEditorLayout` - 整体布局组件
- [ ] `ModeToggle` - Chat/Canvas模式切换组件 (Canvas完全禁用+Coming Soon)
- [ ] `PhotoEditorSidebar` - 侧边栏组件 (集成Better Auth用户状态)
- [ ] `RecentEditList` - 历史会话列表 (前5字符+时间)
- [ ] `ModelSelector` - 模型选择器 (集成积分系统)

### Phase 3: API接口实现 (2-3天)
- [ ] `POST /api/ai-photo-editor/sessions` - 创建会话API (集成Better Auth认证)
- [ ] `GET /api/ai-photo-editor/sessions` - 获取会话列表API
- [ ] `POST /api/ai-photo-editor/process` - AI处理API (集成积分扣减)
- [ ] `GET /api/ai-photo-editor/tasks/:taskId` - 任务状态查询API
- [ ] `POST /api/webhooks/ai-photo-completion` - Webhook回调API
- [ ] AI接口抽象层实现 (支持Replicate平台)

### Phase 4: 对话和预览功能 (2天)
- [ ] `ImageUploadInput` - 图片上传输入组件 (集成现有存储系统)
- [ ] `ImagePreviewPanel` - 图片预览面板 (当前会话图片)
- [ ] 缩略图点击切换主图功能
- [ ] 集成现有对话组件，实现完整对话流程
- [ ] 错误处理：轮询超时"对话失败"、网络异常"网络异常"

### Phase 5: 移动端适配和优化 (1-2天)
- [ ] 抽屉模式实现 (点击按钮触发)
- [ ] 响应式布局优化
- [ ] 移动端交互测试
- [ ] 性能优化和错误边界处理

## 📊 业务规则详细规格

### 💰 积分管理规则
- **扣减时机**: 调用AI接口前先扣减积分
- **失败处理**: 积分扣减成功但AI接口失败时，不回滚积分
- **积分不足**: 显示积分不足提示，引导用户充值，禁止发送对话

### ⏱️ 轮询机制规则
- **持续时间**: 最多40秒自动停止轮询，提示"对话失败"
- **轮询间隔**: 每3秒查询一次任务状态
- **页面状态**: 仅在浏览器窗口激活时进行轮询
- **网络异常**: 提示"网络异常"，不进行自动重试

### 📷 图片处理规则
- **文件大小**: 单张图片最大支持20MB
- **图片数量**: 支持上传多张图片，也可以不上传图片
- **图片处理**: 暂不进行压缩或格式转换
- **AI处理失败**: 不支持重试功能，重试需要重新扣除积分

### 💬 会话和任务管理
- **会话创建**: 每次点击"New Edit"按钮创建新会话
- **任务定义**: 每次在对话框中发送内容 = 一个任务
- **Recent Edit**: 按会话显示，展示第一条prompt的前5字符+创建时间
- **并发控制**: 单个用户不能同时发起多个AI处理任务

### 🔄 系统集成复用
- **积分系统**: 复用现有项目的积分管理功能
- **文件上传**: 复用现有的文件上传逻辑和存储服务
- **用户认证**: 复用现有的用户认证机制
- **国际化**: 支持中英双语国际化

## 📋 API接口规范

基于MkSaaS项目的API架构，新增以下接口：

### 1. 会话管理API
```typescript
// POST /api/ai-photo-editor/sessions - 创建新会话
interface CreateSessionRequest {
  // 无需参数，自动创建
}

interface CreateSessionResponse {
  success: boolean;
  sessionId: string;
  error?: string;
}

// GET /api/ai-photo-editor/sessions - 获取用户会话列表
interface GetSessionsResponse {
  success: boolean;
  sessions: {
    id: string;
    title: string;
    firstPrompt: string;
    taskCount: number;
    lastActivity: string;
    createdAt: string;
  }[];
  error?: string;
}

// PUT /api/ai-photo-editor/sessions/:id - 更新会话
interface UpdateSessionRequest {
  title?: string;
  lastActivity?: string;
}
```

### 2. AI处理API
```typescript
// POST /api/ai-photo-editor/process - 处理AI图片生成请求
interface ProcessAIRequest {
  sessionId: string;
  prompt: string;
  inputImages?: string[]; // 上传后的图片URL数组
  modelId: string; // 'google/nano-banana'
}

interface ProcessAIResponse {
  success: boolean;
  taskId: string;
  error?: string;
}

// GET /api/ai-photo-editor/tasks/:taskId - 查询任务状态
interface GetTaskStatusResponse {
  success: boolean;
  task: {
    id: string;
    status: 'pending' | 'processing' | 'completed' | 'failed';
    outputImageUrl?: string;
    errorMessage?: string;
    createdAt: string;
    completedAt?: string;
  };
  error?: string;
}
```

### 3. 文件上传API (复用现有)
```typescript
// POST /api/storage/upload - 图片上传 (现有接口)
// 使用现有的 uploadFileFromBrowser 函数
// 支持folder参数: 'ai-photo-editor'
```

### 4. Webhook API
```typescript
// POST /api/webhooks/ai-photo-completion - AI完成回调
interface WebhookRequest {
  taskId: string;
  status: 'completed' | 'failed';
  outputUrl?: string;
  errorMessage?: string;
}
```

### 5. 认证中间件
```typescript
// 使用现有的Better Auth认证系统
import { getSession } from '@/lib/server';

export async function authMiddleware(request: Request) {
  const session = await getSession();
  if (!session?.user) {
    return new Response('Unauthorized', { status: 401 });
  }
  return session.user;
}
```

## 🚀 部署和测试

### 环境变量检查 (基于MkSaaS项目)
```bash
# 现有环境变量 (已配置)
STORAGE_BUCKET_NAME=""
STORAGE_ACCESS_KEY_ID=""
STORAGE_SECRET_ACCESS_KEY=""
STORAGE_ENDPOINT=""
STORAGE_PUBLIC_URL=""

# 新增AI相关环境变量
REPLICATE_API_KEY=""
WEBHOOK_URL=""
AI_PHOTO_MODEL_ENDPOINT=""

# 认证相关 (已存在)
BETTER_AUTH_SECRET=""
BETTER_AUTH_URL=""

# 数据库 (已存在)
DATABASE_URL=""
```

### 数据库迁移 (Drizzle ORM)
```bash
# 1. 创建新的迁移文件
npm run db:generate

# 2. 执行迁移 (基于现有MkSaaS迁移流程)
npm run db:migrate

# 3. 验证表结构
npm run db:studio # 打开Drizzle Studio查看表结构
```

### Drizzle Schema更新
```typescript
// src/db/schema.ts - 新增AI相关表定义
import { boolean, integer, pgTable, text, timestamp, index, json } from "drizzle-orm/pg-core";
import { user } from './schema'; // 导入现有user表

export const aiPhotoSession = pgTable("ai_photo_session", {
  id: text("id").primaryKey(),
  userId: text("user_id").notNull().references(() => user.id, { onDelete: 'cascade' }),
  title: text("title").notNull(),
  firstPrompt: text("first_prompt"),
  taskCount: integer("task_count").default(0).notNull(),
  lastActivity: timestamp("last_activity").notNull(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
}, (table) => ({
  userActivityIdx: index("ai_photo_session_user_activity_idx").on(table.userId, table.lastActivity),
  userCreatedIdx: index("ai_photo_session_user_created_idx").on(table.userId, table.createdAt),
}));

export const aiPhotoTask = pgTable("ai_photo_task", {
  id: text("id").primaryKey(),
  userId: text("user_id").notNull().references(() => user.id, { onDelete: 'cascade' }),
  sessionId: text("session_id").notNull().references(() => aiPhotoSession.id, { onDelete: 'cascade' }),
  prompt: text("prompt").notNull(),
  inputImages: json("input_images"), // string[]
  outputImageUrl: text("output_image_url"),
  status: text("status").notNull(), // 'pending' | 'processing' | 'completed' | 'failed'
  taskId: text("task_id"), // 第三方AI任务ID
  providerModel: text("provider_model"),
  creditsCost: integer("credits_cost").notNull(),
  errorMessage: text("error_message"),
  sequenceOrder: integer("sequence_order").notNull(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
  completedAt: timestamp("completed_at"),
}, (table) => ({
  sessionOrderIdx: index("ai_photo_task_session_order_idx").on(table.sessionId, table.sequenceOrder),
  taskIdIdx: index("ai_photo_task_task_id_idx").on(table.taskId),
  userCreatedIdx: index("ai_photo_task_user_created_idx").on(table.userId, table.createdAt),
  statusIdx: index("ai_photo_task_status_idx").on(table.status),
}));
```

### 成功指标
- [ ] 新建会话功能正常
- [ ] 历史会话展示和切换正常
- [ ] 图片上传和预览正常
- [ ] AI模型选择和积分扣减正常
- [ ] 轮询和错误处理正常
- [ ] 响应式布局适配

---

## ✅ 开发任务制定完成

**任务制定时间:** 2025-09-13T23:29:33+08:00
**任务总数:** 16个开发任务
**预计完成时间:** 9-11天

### 📊 任务阶段分布

| 阶段 | 任务数 | 主要内容 | 预计时间 |
|------|--------|----------|----------|
| Phase 1 | 2个 | 基础架构和数据层 | 2天 |
| Phase 2 | 4个 | 核心组件开发 | 2天 |
| Phase 3 | 3个 | API接口实现 | 2-3天 |
| Phase 4 | 5个 | 对话和预览功能 | 2天 |
| Phase 5 | 2个 | 移动端适配和优化 | 1-2天 |

### 🎯 关键任务节点

1. **Task 1**: 数据库Schema设计和迁移 (无依赖，可立即开始)
2. **Task 7**: 会话管理API接口 (前端组件的数据基础)
3. **Task 14**: AI图片编辑主页面 (所有功能的集成点)
4. **Task 16**: 性能优化和错误边界 (最终完善)

### 📋 使用任务管理系统

```bash
# 查看当前任务状态
任务管理系统会显示所有16个任务的详细信息

# 开始第一个任务
从"数据库Schema设计和迁移"开始开发

# 完成任务后更新状态
每完成一个任务立即标记为completed状态

# 查看下一个可执行任务
系统会根据依赖关系显示可以开始的任务
```

### 🔄 开发流程建议

1. **严格按依赖顺序**: 确保前置任务完成后再开始后续任务
2. **并行开发机会**: 无依赖关系的任务可以并行进行
3. **阶段性验收**: 每个Phase完成后进行集成测试
4. **持续集成**: 每个任务完成后立即集成到主分支
5. **文档同步**: 开发过程中及时更新相关文档

**现在可以开始按照任务清单进行有序开发！** 🚀
